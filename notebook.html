<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂçïÁ´†ÂºèTXTÈòÖËØªÂô®</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --header-bg: #ffffff;
            --border-color: #eee;
            --card-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.1);
            --btn-bg: #3498db;
            --btn-hover: #2980b9;
            --btn-active: #2c3e50;
            --loading-bg: rgba(255,255,255,0.8);
            --error-color: #e74c3c;
            --modal-overlay: rgba(0,0,0,0.5);
            --chapter-title: #3498db;
            --nav-bg: #ffffff;
            --chapter-item-hover: #f1f9ff;
            --chapter-item-active: #3498db;
            --current-font: 'Microsoft YaHei', sans-serif;
            --shelf-bg: #f9f9f9;
            --book-card-bg: #fff;
            --book-card-hover: #f0f7ff;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --border-color: #333;
            --card-bg: #1e1e1e;
            --shadow-color: rgba(0,0,0,0.3);
            --btn-bg: #4a6fa5;
            --btn-hover: #5d8cc0;
            --btn-active: #6c9bcf;
            --loading-bg: rgba(30,30,30,0.8);
            --error-color: #ff6b6b;
            --modal-overlay: rgba(0,0,0,0.7);
            --chapter-title: #64b5f6;
            --nav-bg: #1e1e1e;
            --chapter-item-hover: #2a3a4a;
            --chapter-item-active: #4a6fa5;
            --shelf-bg: #1a1a1a;
            --book-card-bg: #222;
            --book-card-hover: #2a3a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            font-family: var(--current-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .upload-area {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
        }

        .upload-area:hover {
            border-color: var(--btn-bg);
            background-color: var(--loading-bg);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--border-color);
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: var(--text-color);
        }

        #file-input {
            display: none;
        }

        .reader-area {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 10px var(--shadow-color);
            min-height: 500px;
            display: none;
        }

        .chapter-title {
            font-size: 24px;
            margin-bottom: 30px;
            color: var(--chapter-title);
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .chapter-content {
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: var(--current-font);
        }

        .loading {
            text-align: center;
            padding: 50px;
            display: none;
            background-color: var(--loading-bg);
            border-radius: 8px;
        }

        .loading-icon {
            font-size: 36px;
            color: var(--btn-bg);
            animation: spin 1s linear infinite;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: var(--error-color);
            display: none;
            background-color: var(--card-bg);
            border-radius: 8px;
        }

        /* Â∫ïÈÉ®Êìç‰ΩúÊ†è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 10px var(--shadow-color);
            display: none;
            z-index: 100;
        }

        .nav-btn {
            padding: 8px 20px;
            border-radius: 4px;
            border: none;
            background-color: var(--btn-bg);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background-color: var(--btn-hover);
        }

        .nav-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        .nav-btn.active {
            background-color: var(--btn-active);
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--btn-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 50;
            border: none;
            font-size: 24px;
        }

        /* Â≠ó‰ΩìÈÄâÊã©ÊåâÈíÆ */
        .font-family-toggle {
            position: fixed;
            top: 20px;
            right: 80px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--btn-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 50;
            border: none;
            font-size: 20px;
        }

        /* ‰π¶Êû∂ÊåâÈíÆ */
        .bookshelf-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--btn-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
            z-index: 50;
            border: none;
            font-size: 20px;
        }

        /* Â≠ó‰ΩìÈÄâÊã©ÂºπÁ™ó */
        .font-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .font-modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .font-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .font-modal-title {
            font-size: 20px;
            color: var(--text-color);
        }

        .close-font-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .font-option {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: transparent;
            color: var(--text-color);
            display: block;
            width: 100%;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .font-option:hover {
            background-color: var(--chapter-item-hover);
        }

        .font-option.active {
            background-color: var(--chapter-item-active);
            color: white;
            border-color: var(--chapter-item-active);
        }

        /* ÁõÆÂΩïÂºπÁ™ó */
        .chapter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            color: var(--text-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .modal-chapter-list {
            list-style: none;
        }

        .modal-chapter-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: transparent;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-chapter-item:hover {
            background-color: var(--chapter-item-hover);
        }

        .modal-chapter-item.active {
            background-color: var(--chapter-item-active);
            color: white;
        }

        .chapter-number {
            font-weight: bold;
            margin-right: 10px;
            min-width: 30px;
        }

        .chapter-name {
            flex: 1;
        }

        /* Â≠ó‰ΩìÂ§ßÂ∞èÊéßÂà∂ */
        .font-controls {
            position: fixed;
            bottom: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 90;
        }

        .font-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: var(--btn-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
            border: none;
            font-size: 18px;
        }

        /* ‰π¶Êû∂Ê†∑Âºè */
        .bookshelf-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .bookshelf-content {
            background-color: var(--shelf-bg);
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .bookshelf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .bookshelf-title {
            font-size: 20px;
            color: var(--text-color);
        }

        .bookshelf-search {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--btn-bg);
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .book-card {
            background-color: var(--book-card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .book-card:hover {
            transform: translateY(-5px);
            background-color: var(--book-card-hover);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .book-title {
            font-weight: bold;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-color);
        }

        .book-info {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .book-progress {
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--btn-bg);
        }

        .remove-book {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .remove-book:hover {
            opacity: 1;
        }

        .empty-shelf {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-shelf i {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
            color: var(--border-color);
        }

        .shelf-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .shelf-tab {
            padding: 6px 15px;
            border-radius: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            white-space: nowrap;
        }

        .shelf-tab.active {
            background-color: var(--btn-bg);
            color: white;
            border-color: var(--btn-bg);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .reader-area {
                padding: 20px;
                min-height: 400px;
            }

            .bottom-nav {
                gap: 10px;
                padding: 10px 0;
            }

            .nav-btn {
                padding: 8px 15px;
                font-size: 14px;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .font-family-toggle {
                top: 10px;
                right: 60px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .bookshelf-toggle {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .font-controls {
                bottom: 70px;
                right: 10px;
            }

            .font-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .modal-content, .font-modal-content, .bookshelf-content {
                width: 95%;
                padding: 15px;
            }

            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Á©∫Áä∂ÊÄÅÊèêÁ§∫ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            color: var(--border-color);
        }

        /* ËøõÂ∫¶ÊåáÁ§∫Âô® */
        .progress-indicator {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
            margin-left: 10px;
        }

        /* ‰π¶Á±ç‰ø°ÊÅØÊ†è */
        .book-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .book-title-bar {
            font-size: 18px;
            font-weight: bold;
        }

        .save-to-shelf-btn {
            padding: 6px 15px;
            border-radius: 4px;
            border: none;
            background-color: var(--btn-bg);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-to-shelf-btn:hover {
            background-color: var(--btn-hover);
        }
    </style>
</head>
<body>
    <!-- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ -->
    <button class="theme-toggle" id="theme-toggle">üåô</button>

    <!-- Â≠ó‰ΩìÈÄâÊã©ÊåâÈíÆ -->
    <button class="font-family-toggle" id="font-family-toggle">Aa</button>

    <!-- ‰π¶Êû∂ÊåâÈíÆ -->
    <button class="bookshelf-toggle" id="bookshelf-toggle">üìö</button>

    <!-- Â≠ó‰ΩìÂ§ßÂ∞èÊéßÂà∂ -->
    <div class="font-controls">
        <button class="font-btn" id="font-decrease">A-</button>
        <button class="font-btn" id="font-reset">A</button>
        <button class="font-btn" id="font-increase">A+</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>ÂçïÁ´†ÂºèTXTÈòÖËØªÂô®</h1>
            <p>‰∏ä‰º†TXTÊñáÊ°£Ôºå‰∫´ÂèóËàíÈÄÇÈòÖËØª‰ΩìÈ™å</p>
        </div>

        <div class="upload-area" id="upload-area">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">ÁÇπÂáªÊàñÊãñÊãΩTXTÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†</div>
            <input type="file" id="file-input" accept=".txt">
        </div>

        <div class="loading" id="loading">
            <div class="loading-icon">‚åõ</div>
            <p>Ê≠£Âú®Âä†ËΩΩÂπ∂Ëß£ÊûêÊñáÊ°£...</p>
        </div>

        <div class="error" id="error">
            <p>‚ùå ‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂ÊòØTXTÊ†ºÂºè</p>
        </div>

        <div class="reader-area" id="reader-area">
            <div class="book-info-bar">
                <div class="book-title-bar" id="book-title-bar"></div>
                <button class="save-to-shelf-btn" id="save-to-shelf-btn">‰øùÂ≠òÂà∞‰π¶Êû∂</button>
            </div>
            <div class="empty-state" id="empty-state">
                <i>üìñ</i>
                <p>ÊöÇÊó†ÂÜÖÂÆπÔºåËØ∑‰∏ä‰º†TXTÊñá‰ª∂ÂºÄÂßãÈòÖËØª</p>
            </div>
            <h2 class="chapter-title" id="current-chapter-title"></h2>
            <div class="chapter-content" id="current-chapter-content"></div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®Êìç‰ΩúÊ†è -->
    <div class="bottom-nav" id="bottom-nav">
        <button class="nav-btn" id="prev-btn" disabled>
            <span>‚óÄ</span> ‰∏ä‰∏ÄÁ´†
        </button>
        <button class="nav-btn" id="toc-btn">
            <span>üìë</span> ÁõÆÂΩï
        </button>
        <button class="nav-btn" id="next-btn">
            ‰∏ã‰∏ÄÁ´† <span>‚ñ∂</span>
        </button>
    </div>

    <!-- ÁõÆÂΩïÂºπÁ™ó -->
    <div class="chapter-modal" id="chapter-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Á´†ËäÇÂàóË°®</h3>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-subtitle" id="modal-subtitle">
                <span id="chapter-count">0</span> ‰∏™Á´†ËäÇ
            </div>
            <ul class="modal-chapter-list" id="modal-chapter-list">
                <!-- Á´†ËäÇÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </ul>
        </div>
    </div>

    <!-- Â≠ó‰ΩìÈÄâÊã©ÂºπÁ™ó -->
    <div class="font-modal" id="font-modal">
        <div class="font-modal-content">
            <div class="font-modal-header">
                <h3 class="font-modal-title">ÈÄâÊã©Â≠ó‰Ωì</h3>
                <button class="close-font-btn" id="close-font-modal">&times;</button>
            </div>
            <button class="font-option" data-font="'Microsoft YaHei', sans-serif">ÂæÆËΩØÈõÖÈªë</button>
            <button class="font-option" data-font="'SimSun', serif">ÂÆã‰Ωì</button>
            <button class="font-option" data-font="'SimHei', sans-serif">Èªë‰Ωì</button>
            <button class="font-option" data-font="'KaiTi', serif">Ê•∑‰Ωì</button>
            <button class="font-option" data-font="'Arial', sans-serif">Arial</button>
            <button class="font-option" data-font="'Times New Roman', serif">Times New Roman</button>
            <button class="font-option" data-font="'Courier New', monospace">Courier New</button>
            <button class="font-option" data-font="'Georgia', serif">Georgia</button>
        </div>
    </div>

    <!-- ‰π¶Êû∂ÂºπÁ™ó -->
    <div class="bookshelf-modal" id="bookshelf-modal">
        <div class="bookshelf-content">
            <div class="bookshelf-header">
                <h3 class="bookshelf-title">ÊàëÁöÑ‰π¶Êû∂</h3>
                <button class="close-btn" id="close-bookshelf">&times;</button>
            </div>

            <div class="shelf-tabs">
                <div class="shelf-tab active" data-filter="all">ÂÖ®ÈÉ®</div>
                <div class="shelf-tab" data-filter="recent">ÊúÄËøëÈòÖËØª</div>
                <div class="shelf-tab" data-filter="unfinished">Êú™ËØªÂÆå</div>
            </div>

            <div class="bookshelf-search">
                <input type="text" class="search-input" placeholder="ÊêúÁ¥¢‰π¶Á±ç..." id="book-search">
            </div>

            <div class="books-grid" id="books-grid">
                <!-- ‰π¶Á±çÂç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>

            <div class="empty-shelf" id="empty-shelf">
                <i>üìö</i>
                <p>‰π¶Êû∂ËøòÊòØÁ©∫ÁöÑ</p>
                <p>‰∏ä‰º†‰π¶Á±çÂπ∂‰øùÂ≠òÂà∞‰π¶Êû∂Âêß</p>
            </div>
        </div>
    </div>

    <script>
        // Ëé∑ÂèñDOMÂÖÉÁ¥†
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const readerArea = document.getElementById('reader-area');
        const currentChapterTitle = document.getElementById('current-chapter-title');
        const currentChapterContent = document.getElementById('current-chapter-content');
        const bottomNav = document.getElementById('bottom-nav');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const tocBtn = document.getElementById('toc-btn');
        const chapterModal = document.getElementById('chapter-modal');
        const closeModal = document.getElementById('close-modal');
        const modalChapterList = document.getElementById('modal-chapter-list');
        const themeToggle = document.getElementById('theme-toggle');
        const fontDecrease = document.getElementById('font-decrease');
        const fontReset = document.getElementById('font-reset');
        const fontIncrease = document.getElementById('font-increase');
        const emptyState = document.getElementById('empty-state');
        const chapterCount = document.getElementById('chapter-count');
        const fontFamilyToggle = document.getElementById('font-family-toggle');
        const fontModal = document.getElementById('font-modal');
        const closeFontModal = document.getElementById('close-font-modal');
        const fontOptions = document.querySelectorAll('.font-option');
        const bookshelfToggle = document.getElementById('bookshelf-toggle');
        const bookshelfModal = document.getElementById('bookshelf-modal');
        const closeBookshelf = document.getElementById('close-bookshelf');
        const booksGrid = document.getElementById('books-grid');
        const emptyShelf = document.getElementById('empty-shelf');
        const bookSearch = document.getElementById('book-search');
        const shelfTabs = document.querySelectorAll('.shelf-tab');
        const saveToShelfBtn = document.getElementById('save-to-shelf-btn');
        const bookTitleBar = document.getElementById('book-title-bar');

        // ÂÖ®Â±ÄÂèòÈáè
        let chapters = [];
        let currentChapterIndex = 0;
        let fontSize = 16; // ÈªòËÆ§Â≠ó‰ΩìÂ§ßÂ∞è
        let currentFont = "'Microsoft YaHei', sans-serif"; // ÈªòËÆ§Â≠ó‰Ωì
        let bookshelf = []; // ‰π¶Êû∂
        let currentBook = null; // ÂΩìÂâçÈòÖËØªÁöÑ‰π¶Á±ç
        let currentFileContent = null; // ÂΩìÂâçÊñá‰ª∂ÂÜÖÂÆπ

        // Â¢ûÂº∫ÁöÑÁ´†ËäÇËØÜÂà´Ê≠£ÂàôË°®ËææÂºèÔºàÊîØÊåÅÊõ¥Â§öÊ†ºÂºèÔºâ
        const chapterRegex = /^(Á¨¨\s*\d{1,4}\s*[Á´†ËäÇÂõûÂç∑ÈõÜÈÉ®ÁØá]\s*.*|Á¨¨\s*[Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅÁôæÂçÉ‰∏á]+\s*[Á´†ËäÇÂõûÂç∑ÈõÜÈÉ®ÁØá]\s*.*|Chapter\s*\d+.*|Section\s*\d+.*|\d+\.\s*.*|Á¨¨\s*\d+\s*Á´†.*)/gm;

        // ÂàùÂßãÂåñÂ∫îÁî®
        function initApp() {
            // Âä†ËΩΩ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò„ÄÅÂ≠ó‰ΩìËÆæÁΩÆÂíå‰π¶Êû∂
            loadSettings();

            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            setupEventListeners();

            // Ê∏≤Êüì‰π¶Êû∂
            renderBookshelf();
        }

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // ‰∏ä‰º†Âå∫Âüü‰∫ã‰ª∂
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            fileInput.addEventListener('change', handleFileSelect);

            // ÂØºËà™ÊåâÈíÆ‰∫ã‰ª∂
            prevBtn.addEventListener('click', goToPrevChapter);
            nextBtn.addEventListener('click', goToNextChapter);
            tocBtn.addEventListener('click', openChapterModal);
            closeModal.addEventListener('click', closeChapterModal);

            // Á´†ËäÇÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂
            chapterModal.addEventListener('click', (e) => {
                if (e.target === chapterModal) closeChapterModal();
            });

            // ‰∏ªÈ¢òÂàáÊç¢‰∫ã‰ª∂
            themeToggle.addEventListener('click', toggleTheme);

            // Â≠ó‰ΩìÊéßÂà∂‰∫ã‰ª∂
            fontDecrease.addEventListener('click', () => changeFontSize(-2));
            fontReset.addEventListener('click', resetFontSize);
            fontIncrease.addEventListener('click', () => changeFontSize(2));

            // Â≠ó‰ΩìÈÄâÊã©‰∫ã‰ª∂
            fontFamilyToggle.addEventListener('click', openFontModal);
            closeFontModal.addEventListener('click', closeFontModalWindow);
            fontModal.addEventListener('click', (e) => {
                if (e.target === fontModal) closeFontModalWindow();
            });

            // Â≠ó‰ΩìÈÄâÈ°π‰∫ã‰ª∂
            fontOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const font = option.getAttribute('data-font');
                    changeFontFamily(font);
                });
            });

            // ‰π¶Êû∂‰∫ã‰ª∂
            bookshelfToggle.addEventListener('click', openBookshelf);
            closeBookshelf.addEventListener('click', closeBookshelfWindow);
            bookshelfModal.addEventListener('click', (e) => {
                if (e.target === bookshelfModal) closeBookshelfWindow();
            });

            // ‰π¶Êû∂ÊêúÁ¥¢‰∫ã‰ª∂
            bookSearch.addEventListener('input', filterBooks);

            // ‰π¶Êû∂Ê†áÁ≠æ‰∫ã‰ª∂
            shelfTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    shelfTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterBooks();
                });
            });

            // ‰øùÂ≠òÂà∞‰π¶Êû∂ÊåâÈíÆ‰∫ã‰ª∂
            saveToShelfBtn.addEventListener('click', saveCurrentBookToShelf);
        }

        // Â§ÑÁêÜÊãñÊãΩ‰∫ã‰ª∂
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--btn-bg');
            uploadArea.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--loading-bg');
        }

        function handleDragLeave() {
            uploadArea.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            uploadArea.style.backgroundColor = '';
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            uploadArea.style.backgroundColor = '';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Â§ÑÁêÜÊñá‰ª∂
        function handleFile(file) {
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.name.endsWith('.txt')) {
                showError();
                return;
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading();

            // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;
                currentFileContent = content;
                chapters = parseChapters(content);

                // ÂàõÂª∫ÂΩìÂâç‰π¶Á±ç‰ø°ÊÅØ
                currentBook = {
                    id: generateId(),
                    title: file.name.replace('.txt', ''),
                    fileName: file.name,
                    lastRead: new Date().toISOString(),
                    totalChapters: chapters.length,
                    currentChapter: 0,
                    content: content // Â≠òÂÇ®ÂÜÖÂÆπ‰ª•‰æø‰øùÂ≠òÂà∞‰π¶Êû∂
                };

                // Êõ¥Êñ∞‰π¶Á±çÊ†áÈ¢òÊ†è
                bookTitleBar.textContent = currentBook.title;

                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Âú®‰π¶Êû∂‰∏≠
                const existingBookIndex = bookshelf.findIndex(book => book.fileName === currentBook.fileName);
                if (existingBookIndex !== -1) {
                    // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞ÂΩìÂâçÁ´†ËäÇÂíåÊúÄÂêéÈòÖËØªÊó∂Èó¥
                    currentBook.currentChapter = bookshelf[existingBookIndex].currentChapter;
                    saveToShelfBtn.textContent = "Â∑≤Âú®‰π¶Êû∂‰∏≠";
                    saveToShelfBtn.disabled = true;
                } else {
                    saveToShelfBtn.textContent = "‰øùÂ≠òÂà∞‰π¶Êû∂";
                    saveToShelfBtn.disabled = false;
                }

                // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅÔºåÊòæÁ§∫ÈòÖËØªÂô®ÂíåÂ∫ïÈÉ®ÂØºËà™
                hideAll();
                readerArea.style.display = 'block';
                bottomNav.style.display = 'flex';

                // ÊòæÁ§∫Á¨¨‰∏ÄÁ´†ÊàñÁ©∫Áä∂ÊÄÅ
                if (chapters.length > 0) {
                    showChapter(currentBook.currentChapter);
                    renderChapterModal();
                } else {
                    showEmptyState();
                }

                // ÈáçÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è
                resetFontSize();
            };

            reader.onerror = () => {
                showError();
            };

            // ËØªÂèñTXTÊñá‰ª∂
            reader.readAsText(file, 'utf-8');
        }

        // Ëß£ÊûêÁ´†ËäÇ
        function parseChapters(content) {
            const chapters = [];
            let match;
            let lastIndex = 0;
            let chapterIndex = 0;

            // ÊâæÂá∫ÊâÄÊúâÁ´†ËäÇÊ†áÈ¢ò
            while ((match = chapterRegex.exec(content)) !== null) {
                const chapterTitle = match[0].trim();
                const chapterStart = match.index;
                const chapterEnd = chapterRegex.lastIndex;

                // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏Ä‰∏™Á´†ËäÇÔºåÊ∑ªÂä†Ââç‰∏Ä‰∏™Á´†ËäÇÁöÑÂÜÖÂÆπ
                if (chapterIndex > 0) {
                    const chapterContent = content.substring(lastIndex, chapterStart).trim();
                    chapters[chapterIndex - 1].content = chapterContent;
                }

                // Ê∑ªÂä†Êñ∞Á´†ËäÇ
                chapters.push({
                    id: `chapter-${chapterIndex}`,
                    title: chapterTitle,
                    content: '',
                    number: chapterIndex + 1
                });

                lastIndex = chapterEnd;
                chapterIndex++;
            }

            // Ê∑ªÂä†ÊúÄÂêé‰∏Ä‰∏™Á´†ËäÇÁöÑÂÜÖÂÆπ
            if (chapters.length > 0) {
                const lastChapterContent = content.substring(lastIndex).trim();
                chapters[chapters.length - 1].content = lastChapterContent;
            }

            // Â¶ÇÊûúÊ≤°ÊúâËØÜÂà´Âà∞Á´†ËäÇÔºåÂàõÂª∫‰∏Ä‰∏™ÈªòËÆ§Á´†ËäÇ
            if (chapters.length === 0) {
                chapters.push({
                    id: 'chapter-0',
                    title: 'ÂÖ®Êñá',
                    content: content.trim(),
                    number: 1
                });
            }

            return chapters;
        }

        // ÊòæÁ§∫ÊåáÂÆöÁ´†ËäÇ
        function showChapter(index) {
            if (chapters.length === 0) return;

            // Êõ¥Êñ∞ÂΩìÂâçÁ´†ËäÇÁ¥¢Âºï
            currentChapterIndex = index;

            // Êõ¥Êñ∞Á´†ËäÇÂÜÖÂÆπ
            const chapter = chapters[index];
            currentChapterTitle.textContent = chapter.title;
            currentChapterContent.textContent = chapter.content;
            currentChapterContent.style.fontSize = `${fontSize}px`;

            // Â∫îÁî®ÂΩìÂâçÂ≠ó‰Ωì
            applyCurrentFont();

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateNavButtons();

            // Êõ¥Êñ∞ÁõÆÂΩïÈÄâ‰∏≠Áä∂ÊÄÅ
            updateModalChapterActive();

            // ÊªöÂä®Âà∞È°∂ÈÉ®
            window.scrollTo(0, 0);

            // ÈöêËóèÁ©∫Áä∂ÊÄÅ
            emptyState.style.display = 'none';
            currentChapterTitle.style.display = 'block';
            currentChapterContent.style.display = 'block';

            // Êõ¥Êñ∞ÂΩìÂâç‰π¶Á±çÁöÑÈòÖËØªËøõÂ∫¶
            if (currentBook) {
                currentBook.currentChapter = index;
                currentBook.lastRead = new Date().toISOString();

                // Â¶ÇÊûúÂ∑≤Âú®‰π¶Êû∂‰∏≠ÔºåÊõ¥Êñ∞ËøõÂ∫¶
                const existingBookIndex = bookshelf.findIndex(book => book.id === currentBook.id);
                if (existingBookIndex !== -1) {
                    bookshelf[existingBookIndex].currentChapter = index;
                    bookshelf[existingBookIndex].lastRead = currentBook.lastRead;
                    saveBookshelf();
                    renderBookshelf();
                }
            }
        }

        // Â∫îÁî®ÂΩìÂâçÂ≠ó‰Ωì
        function applyCurrentFont() {
            document.documentElement.style.setProperty('--current-font', currentFont);
            document.body.style.fontFamily = currentFont;
            currentChapterContent.style.fontFamily = currentFont;
            currentChapterTitle.style.fontFamily = currentFont;
        }

        // ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
        function showEmptyState() {
            emptyState.style.display = 'block';
            currentChapterTitle.style.display = 'none';
            currentChapterContent.style.display = 'none';
        }

        // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅ
        function updateNavButtons() {
            prevBtn.disabled = currentChapterIndex === 0;
            nextBtn.disabled = currentChapterIndex === chapters.length - 1;
        }

        // ÁîüÊàêÁõÆÂΩïÂºπÁ™ó
        function renderChapterModal() {
            modalChapterList.innerHTML = '';
            chapterCount.textContent = chapters.length;

            chapters.forEach((chapter, index) => {
                const li = document.createElement('li');
                li.className = `modal-chapter-item ${index === currentChapterIndex ? 'active' : ''}`;
                li.dataset.index = index;

                // ÂàõÂª∫Á´†ËäÇÁºñÂè∑ÂÖÉÁ¥†
                const chapterNumber = document.createElement('span');
                chapterNumber.className = 'chapter-number';
                chapterNumber.textContent = chapter.number;

                // ÂàõÂª∫Á´†ËäÇÂêçÁß∞ÂÖÉÁ¥†
                const chapterName = document.createElement('span');
                chapterName.className = 'chapter-name';
                chapterName.textContent = chapter.title;

                // ÂàõÂª∫ËøõÂ∫¶ÊåáÁ§∫Âô®
                const progressIndicator = document.createElement('span');
                progressIndicator.className = 'progress-indicator';
                progressIndicator.textContent = `${index + 1}/${chapters.length}`;

                // ÁªÑË£ÖÂàóË°®È°π
                li.appendChild(chapterNumber);
                li.appendChild(chapterName);
                li.appendChild(progressIndicator);

                li.addEventListener('click', () => {
                    showChapter(index);
                    closeChapterModal();
                });

                modalChapterList.appendChild(li);
            });
        }

        // Êõ¥Êñ∞ÁõÆÂΩïÈÄâ‰∏≠Áä∂ÊÄÅ
        function updateModalChapterActive() {
            document.querySelectorAll('.modal-chapter-item').forEach((item, index) => {
                item.classList.toggle('active', index === currentChapterIndex);
            });
        }

        // ÊâìÂºÄÁõÆÂΩïÂºπÁ™ó
        function openChapterModal() {
            if (chapters.length === 0) return;
            chapterModal.style.display = 'flex';
        }

        // ÂÖ≥Èó≠ÁõÆÂΩïÂºπÁ™ó
        function closeChapterModal() {
            chapterModal.style.display = 'none';
        }

        // ÊâìÂºÄÂ≠ó‰ΩìÈÄâÊã©ÂºπÁ™ó
        function openFontModal() {
            fontModal.style.display = 'flex';
            updateFontOptionsActiveState();
        }

        // ÂÖ≥Èó≠Â≠ó‰ΩìÈÄâÊã©ÂºπÁ™ó
        function closeFontModalWindow() {
            fontModal.style.display = 'none';
        }

        // Êõ¥Êñ∞Â≠ó‰ΩìÈÄâÈ°πÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
        function updateFontOptionsActiveState() {
            fontOptions.forEach(option => {
                const font = option.getAttribute('data-font');
                option.classList.toggle('active', font === currentFont);
            });
        }

        // ÂàáÊç¢Âà∞‰∏ä‰∏ÄÁ´†
        function goToPrevChapter() {
            if (currentChapterIndex > 0) {
                showChapter(currentChapterIndex - 1);
            }
        }

        // ÂàáÊç¢Âà∞‰∏ã‰∏ÄÁ´†
        function goToNextChapter() {
            if (currentChapterIndex < chapters.length - 1) {
                showChapter(currentChapterIndex + 1);
            }
        }

        // ÂàáÊç¢‰∏ªÈ¢ò
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            saveSettings();
        }

        // ÊîπÂèòÂ≠ó‰ΩìÂ§ßÂ∞è
        function changeFontSize(delta) {
            fontSize += delta;
            fontSize = Math.max(12, Math.min(24, fontSize)); // ÈôêÂà∂Âú®12-24px‰πãÈó¥
            currentChapterContent.style.fontSize = `${fontSize}px`;
            saveSettings();
        }

        // ÈáçÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è
        function resetFontSize() {
            fontSize = 16;
            currentChapterContent.style.fontSize = `${fontSize}px`;
            saveSettings();
        }

        // Êõ¥ÊîπÂ≠ó‰ΩìÊóè
        function changeFontFamily(font) {
            currentFont = font;
            applyCurrentFont();
            closeFontModalWindow();
            saveSettings();
        }

        // ‰øùÂ≠òÂΩìÂâç‰π¶Á±çÂà∞‰π¶Êû∂
        function saveCurrentBookToShelf() {
            if (!currentBook || !currentFileContent) return;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Âú®‰π¶Êû∂‰∏≠
            const existingBookIndex = bookshelf.findIndex(book => book.fileName === currentBook.fileName);

            if (existingBookIndex === -1) {
                // Ê∑ªÂä†Âà∞‰π¶Êû∂
                bookshelf.push({...currentBook});
                saveBookshelf();
                renderBookshelf();

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                saveToShelfBtn.textContent = "Â∑≤Âú®‰π¶Êû∂‰∏≠";
                saveToShelfBtn.disabled = true;

                // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                alert("Â∑≤‰øùÂ≠òÂà∞‰π¶Êû∂");
            }
        }

        // ‰ªé‰π¶Êû∂‰∏≠ÁßªÈô§‰π¶Á±ç
        function removeBookFromShelf(bookId) {
            bookshelf = bookshelf.filter(book => book.id !== bookId);
            saveBookshelf();
            renderBookshelf();
        }

        // ÊâìÂºÄ‰π¶Êû∂‰∏≠ÁöÑ‰π¶Á±ç
        function openBookFromShelf(book) {
            // ÂÖ≥Èó≠‰π¶Êû∂
            closeBookshelfWindow();

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            showLoading();

            // Ëß£Êûê‰π¶Á±çÂÜÖÂÆπ
            currentFileContent = book.content;
            chapters = parseChapters(book.content);

            // Êõ¥Êñ∞ÂΩìÂâç‰π¶Á±ç‰ø°ÊÅØ
            currentBook = {
                ...book,
                lastRead: new Date().toISOString()
            };

            // Êõ¥Êñ∞‰π¶Á±çÊ†áÈ¢òÊ†è
            bookTitleBar.textContent = currentBook.title;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            saveToShelfBtn.textContent = "Â∑≤Âú®‰π¶Êû∂‰∏≠";
            saveToShelfBtn.disabled = true;

            // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅÔºåÊòæÁ§∫ÈòÖËØªÂô®ÂíåÂ∫ïÈÉ®ÂØºËà™
            hideAll();
            readerArea.style.display = 'block';
            bottomNav.style.display = 'flex';

            // ÊòæÁ§∫‰∏äÊ¨°ÈòÖËØªÁöÑÁ´†ËäÇ
            if (chapters.length > 0) {
                showChapter(currentBook.currentChapter);
                renderChapterModal();
            } else {
                showEmptyState();
            }

            // Êõ¥Êñ∞‰π¶Êû∂‰∏≠ÁöÑÊúÄÂêéÈòÖËØªÊó∂Èó¥
            const existingBookIndex = bookshelf.findIndex(b => b.id === book.id);
            if (existingBookIndex !== -1) {
                bookshelf[existingBookIndex].lastRead = currentBook.lastRead;
                saveBookshelf();
            }
        }

        // Ê∏≤Êüì‰π¶Êû∂
        function renderBookshelf() {
            if (bookshelf.length === 0) {
                booksGrid.style.display = 'none';
                emptyShelf.style.display = 'block';
                return;
            }

            // ÂÖàÈöêËóèÁ©∫Áä∂ÊÄÅ
            booksGrid.style.display = 'grid';
            emptyShelf.style.display = 'none';

            // ËøáÊª§‰π¶Á±ç
            filterBooks();
        }

        // ËøáÊª§‰π¶Á±ç
        function filterBooks() {
            const searchTerm = bookSearch.value.toLowerCase();
            const activeTab = document.querySelector('.shelf-tab.active').dataset.filter;

            // ÂÖàÊåâÊúÄÂêéÈòÖËØªÊó∂Èó¥ÊéíÂ∫è
            const sortedBooks = [...bookshelf].sort((a, b) =>
                new Date(b.lastRead) - new Date(a.lastRead)
            );

            // Â∫îÁî®ËøáÊª§Âô®
            let filteredBooks = sortedBooks;

            if (activeTab === 'recent') {
                // Âè™ÊòæÁ§∫ÊúÄËøëÈòÖËØªÁöÑÔºà7Â§©ÂÜÖÔºâ
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                filteredBooks = filteredBooks.filter(book =>
                    new Date(book.lastRead) >= sevenDaysAgo
                );
            } else if (activeTab === 'unfinished') {
                // Âè™ÊòæÁ§∫Êú™ËØªÂÆåÁöÑ
                filteredBooks = filteredBooks.filter(book =>
                    book.currentChapter < book.totalChapters - 1
                );
            }

            // Â∫îÁî®ÊêúÁ¥¢
            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book =>
                    book.title.toLowerCase().includes(searchTerm)
                );
            }

            // Ê∏≤ÊüìËøáÊª§ÂêéÁöÑ‰π¶Á±ç
            booksGrid.innerHTML = '';

            if (filteredBooks.length === 0) {
                booksGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.7;">
                        <p>Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑ‰π¶Á±ç</p>
                    </div>
                `;
                return;
            }

            filteredBooks.forEach(book => {
                const progress = book.totalChapters > 0
                    ? (book.currentChapter / book.totalChapters) * 100
                    : 0;

                const card = document.createElement('div');
                card.className = 'book-card';
                card.innerHTML = `
                    <button class="remove-book" data-id="${book.id}">√ó</button>
                    <div class="book-title">${book.title}</div>
                    <div class="book-info">Á´†ËäÇ: ${book.currentChapter + 1}/${book.totalChapters}</div>
                    <div class="book-info">‰∏äÊ¨°ÈòÖËØª: ${formatDate(book.lastRead)}</div>
                    <div class="book-progress">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                `;

                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÊâìÂºÄ‰π¶Á±ç
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-book')) {
                        openBookFromShelf(book);
                    }
                });

                // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
                const removeBtn = card.querySelector('.remove-book');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Á°ÆÂÆöË¶Å‰ªé‰π¶Êû∂‰∏≠ÁßªÈô§„Ää${book.title}„ÄãÂêóÔºü`)) {
                        removeBookFromShelf(book.id);
                    }
                });

                booksGrid.appendChild(card);
            });
        }

        // ÊâìÂºÄ‰π¶Êû∂
        function openBookshelf() {
            bookshelfModal.style.display = 'flex';
            renderBookshelf();
        }

        // ÂÖ≥Èó≠‰π¶Êû∂
        function closeBookshelfWindow() {
            bookshelfModal.style.display = 'none';
            bookSearch.value = ''; // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
        }

        // ‰øùÂ≠òËÆæÁΩÆÂà∞localStorage
        function saveSettings() {
            const settings = {
                darkMode: document.body.classList.contains('dark-mode'),
                fontSize: fontSize,
                fontFamily: currentFont
            };
            localStorage.setItem('readerSettings', JSON.stringify(settings));
        }

        // ‰øùÂ≠ò‰π¶Êû∂Âà∞localStorage
        function saveBookshelf() {
            localStorage.setItem('bookshelf', JSON.stringify(bookshelf));
        }

        // ‰ªélocalStorageÂä†ËΩΩËÆæÁΩÆ
        function loadSettings() {
            // Âä†ËΩΩÈòÖËØªÂô®ËÆæÁΩÆ
            const savedSettings = localStorage.getItem('readerSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);

                // Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    themeToggle.textContent = '‚òÄÔ∏è';
                }

                // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
                if (settings.fontSize) {
                    fontSize = settings.fontSize;
                }

                // Â∫îÁî®Â≠ó‰ΩìËÆæÁΩÆ
                if (settings.fontFamily) {
                    currentFont = settings.fontFamily;
                    applyCurrentFont();
                }
            }

            // Âä†ËΩΩ‰π¶Êû∂
            const savedBookshelf = localStorage.getItem('bookshelf');
            if (savedBookshelf) {
                bookshelf = JSON.parse(savedBookshelf);
            }
        }

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        function showLoading() {
            hideAll();
            loading.style.display = 'block';
        }

        // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
        function showError() {
            hideAll();
            error.style.display = 'block';
        }

        // ÈöêËóèÊâÄÊúâÁä∂ÊÄÅ
        function hideAll() {
            loading.style.display = 'none';
            error.style.display = 'none';
            readerArea.style.display = 'none';
            bottomNav.style.display = 'none';
            chapterModal.style.display = 'none';
            fontModal.style.display = 'none';
            bookshelfModal.style.display = 'none';
        }

        // ÁîüÊàêÂîØ‰∏ÄID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return '‰ªäÂ§©';
            } else if (diffDays === 1) {
                return 'Êò®Â§©';
            } else if (diffDays < 7) {
                return `${diffDays}Â§©Ââç`;
            } else {
                return `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>